### Поток
Пусть имеется сеть (взвешенный ориентированный граф) с одним источником $s$ и одним стоком $t$. 

Вершина $s$ сети является **источником**, если не существует дуг, входящих в эту вершину. Вершина $t$ является **стоком**, если не существует дуг, исходящих из этой вершины. 

Будем считать, что каждая дуга е имеет пропускную способность $р(е)$, которая выражается натуральным числом. 

**Потоком** в такой сети называется функционал $f$, заданный на её дугах и удовлетворяющий следующим двум требованиям:
1. Для каждой дуги $e$ выполняется неравенство $0 \leq f(e) \leq p(e)$;
2. Для каждой вершины $v$, кроме источника и стока, выполняется равенство $\sum_{e \in In(v)} f(e) = \sum_{e \in Out(v)} f(e),$

где $In(v)$ - множество дуг, входящих в вершину $v$, a $Out(v)$ - множество дуг, исходящих из вершины $v$.

Число $f(e)$ будем называть **локальным потоком** вдоль дуги $e$. Указанные в определении два требования к локальным потокам вполне объяснимы. Например, если исходная сеть - это транспортная сеть, где дуги - это дороги, а вершины - это перекрёстки, то пропускную способность $р(е)$ дуги $е$ можно интерпретировать как максимальное количество автомобилей, которые теоретически могут находиться на данной дороге, двигаясь в направлении данной дуги. Пропускная способность дороги зависит от её ширины, числа полос, качества дороги, ограничений скорости движения по ней и т.д. Тогда под локальным потоком $f(e)$ вдоль дуги е в данном случае следует понимать реальное количество автомобилей, передвигающихся по данной дороге в заданном направлении.

Дуга, у которой локальный поток совпадает с её пропускной способностью, называется **насыщенной дугой**.

---
### Условия

> 1. Для каждого ребра $е$ выполняется неравенство $0 \leq f(e) \leq p(e)$;
> 2. Для каждой вершины $v$, кроме источника и стока, выполняется равенство $\sum_{e \in In(v)} f(e) = \sum_{e \in Out(v)} f(e),$ где $In(v)$ - множество дуг, входящих в вершину $v$, a $Out(v)$ - множество дуг, исходящих из вершины $v$.

---
### Закон сохранения

Из условия сохранения потока в каждой вершине сети, кроме источника и стока, следует **глобальный закон** сохранения:

$\sum_{e \in In(t)} f(e) = \sum_{e \in Out(s)} f(e) = F$

где число $F$ - это величина потока. Глобальный закон сохранения, по сути, означает, что все автомобили, которые выехали из источника (их суммарное количество и есть величина потока $F$), должны в итоге приехать в сток. Иными словами, в транспортной сети автомобили не должны возникать «из ничего» и исчезать «в никуда».
---
### Разрез
**Разрезом сети** называется такое разбиение множества её вершин на два подмножества $V_1$ и $V_2$, при котором $s \in V_1$, $t \in V_2$. 

Известно, что в $n$-вершинной сети существует $2^{n - 2}$ различных разрезов.
---
### Теорема Форда-Фалкерсона

Справедлива следующая теорема Форда-Фалкерсона, связывающая максимальный поток в сети и её минимальный разрез.

> Максимальная величина потока в сети равна минимальной пропускной способности разреза этой сети.

---
### Остаточная цепь

Если в исходной сети существует некоторый поток, то можно построить так называемую остаточную сеть. 

**Остаточная сеть** – это сеть с тем же набором вершин, что и у исходной сети. Наличие дуг и их веса в остаточной сети определяются по следующим правилам: 
1. Если дуга $e$ исходной сети является насыщенной (т.е. локальный поток $f(e)$ равен пропускной способности), то в остаточной сети проводим дугу $e$ с весом $p(e)$;
2. Если дуга $e=[v_{i},v_{j}]$ исходной сети является пустой (т.е. локальный поток $f(e)$ равен нулю), то в остаточной сети проводим обратную дугу $[v_{j},v_{i}]$ с весом $p(e)$;
3. Если дуга $e=[v_{i},v_{j}]$ исходной сети не является ни пустой, ни насыщенной (т.е. для неё выполняются неравенства $0<f(e)<p(e)$ ), то в остаточной сети проводим две дуги: саму дугу $e=[v_{i},v_{j}]$ с весом $f(e)$ и обратную дугу $[v_{j},v_{i}]$ с весом, равным $p(e)-f(e)$.

Любой ориентированный путь в остаточной сети из стока $t$ в источник $s$ называется **увеличивающим путём**.
---
### Теорема
Поток в исходной сети является **максимальным** тогда и только тогда, когда в остаточной сети *нет ни одного увеличивающего пути*.

---
### Алгоритм для нахождения максимального потока

Рассмотрим теперь алгоритм для нахождения максимального потока. Он состоит в постепенном наращивании уже имеющегося потока вдоль некоторого ориентированного пути из источника $s$ в сток $t$. Поиск такого пути осуществляется с помощью остаточной сети. Наращивание потока происходит до тех пор, пока его величина не станет максимально возможной для заданной сети. В качестве начального можно взять, например, нулевой поток.

Пусть после очередного увеличения потока в процессе работы алгоритма мы получили некоторый ненулевой поток. Построим соответствующую этому потоку остаточную сеть и найдём в ней какой-либо увеличивающий путь. Предположим, что это путь из дуг $e_{i},e_{j},...,e_{k}$. Через $d$ обозначим минимальный вес дуг, образующих этот путь. Уменьшим на величину $d$ веса всех дуг $e_{i},e_{j},...,e_{k}$. Дуги, веса которых станут после этого нулевыми, удалим из остаточной сети. 

Уменьшение весов дуг $e_{i},e_{j},e_{k}$ на величину $d$ в остаточной сети означает следующую корректировку локальных потоков в исходной сети:
1. Если дуга $e$ из увеличивающего пути существует в исходной сети, то локальный поток вдоль неё $f(e)$ уменьшается на величину $d$. 
2. Если же дуга $e$ в исходной сети отсутствует, то в ней имеется дуга, обратная по отношению к $e$. Уменьшение веса дуги $e$ на величину $d$ в остаточной сети означает уменьшение резерва в исходной сети, что эквивалентно увеличению локального потока вдоль дуги, обратной по отношению к $e$, на величину $d$. Вследствие указанной корректировки локальных потоков ровно на величину $d$ возрастает и величина потока. 

Как уже было сказано, после нахождения увеличивающего пути в остаточной сети происходит корректировка обеих сетей – и остаточной, и исходной. 

В скорректированной остаточной сети снова ищут увеличивающий путь и корректируют обе сети и т.д. Алгоритм завершает работу, как только в остаточной сети не останется ни одного увеличивающего пути. В этот момент веса дуг в остаточной сети будут показывать реальные локальные потоки, а также неиспользованные резервы, что тоже может представлять интерес, например, для внесения изменений в исходную сеть (добавление дуг, повышение пропускных способностей дуг) с целью увеличить уже существующий поток.
---
### Алгоритм для нахождения максимального потока минимальной стоимости

Пусть в исходной сети уже найден некоторый максимальный поток. Если в соответствующей остаточной сети нет ни одного ориентированного цикла отрицательной стоимости, то алгоритм завершил работу, а найденный максимальный поток имеет минимально возможную стоимость.

Если же в остаточной сети есть ориентированный цикл $e_{i},e_{j},\dots ,e_{k}$ отрицательной стоимости $cost$, то через $d$ обозначим минимальный вес дуг, образующих этот цикл. 

В остаточной сети выполним следующие преобразования. Уменьшим на $d$ вес каждой из дуг $e_{i},e_{j},\dots ,e_{k}$ и удалим те из них, вес которых станет равным нулю. Одновременно увеличим на $d$ веса всех дуг, обратных по отношению к $e_{i},e_{j},\dots ,e_{k}$. Если какая-либо из дуг $e_{i},e_{j},\dots ,e_{k}$ в остаточной сети не имела обратной дуги, то в новой остаточной сети добавим такую дугу и положим её вес равным $d$.

Указанные преобразования остаточной сети означают, что в исходной сети мы перенаправили локальные потоки на некоторых дугах так, что величина глобального потока $F$ не изменилась (т.е. он остался максимальным), но его стоимость уменьшилась на величину, равную $d\cdot (-cost)$, где $cost$ – отрицательная стоимость обнаруженного цикла $e_{i},e_{j},\dots ,e_{k}$.

В результате указанных действий в остаточной сети исчезает хотя бы один цикл отрицательной стоимости, а в исходной сети происходит перераспределение локальных потоков так, что глобальный поток остаётся максимальным по величине, но его стоимость при этом уменьшается. 

В преобразованной остаточной сети снова ищут ориентированный цикл отрицательной стоимости и удаляют его, что приводит к перераспределению локальных потоков с сохранением величины глобального потока $F$ и т.д. 

Алгоритм завершает работу, как только в остаточной сети не останется ни одного ориентированного цикла отрицательной стоимости. Окончательные локальные потоки вдоль дуг исходной сети будут равны весам соответствующих дуг в остаточной сети.

Циклы отрицательной стоимости в остаточной сети можно находить с помощью рассмотренного ранее алгоритма Флойда. 
